cmake_minimum_required(VERSION 3.18)
project(CCL)

set(CMAKE_C_STANDARD 99)
set(CMAKE_CXX_STANDARD 17)

SET(EXECUTABLE_OUTPUT_PATH ${CMAKE_SOURCE_DIR}/bin)

# ğŸ”¥ å…³é”®ä¿®æ”¹ 1ï¼šç¡®ä¿ CMake èƒ½æ‰¾åˆ° LLVM
if(NOT DEFINED LLVM_DIR)
    set(LLVM_DIR "~/llvm_project_1706/llvm_install_dir/lib/cmake/llvm")  # è®¾ç½® LLVM_DIR
endif()

# ğŸ”¥ å…³é”®ä¿®æ”¹ 2ï¼šæ‰¾åˆ° LLVM å¹¶ä»…ä½¿ç”¨ MIPS ç»„ä»¶
find_package(LLVM REQUIRED CONFIG)

list(APPEND CMAKE_MODULE_PATH ${LLVM_CMAKE_DIR})

include(AddLLVM)
include_directories("${LLVM_BINARY_DIR}/include" "${LLVM_INCLUDE_DIR}")
add_definitions(${LLVM_DEFINITIONS})

# æ·»åŠ å¤´æ–‡ä»¶æœç´¢è·¯å¾„
include_directories(/home/lin/CCl/include)

# å¤„ç†å¼‚å¸¸é€‰é¡¹
string(REPLACE "-fno-exceptions" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fexceptions")

# ğŸ”¥ å…³é”®ä¿®æ”¹ 3ï¼šç§»é™¤ X86ï¼Œæ·»åŠ  MIPS ç»„ä»¶
set(LLVM_LINK_COMPONENTS 
Support 
    Core 
    TargetParser
    MC          # æœºå™¨ç å±‚ç»„ä»¶
    # ğŸ”¥ MIPS ç»„ä»¶ï¼ˆä»ç„¶ä¿ç•™ï¼‰
    MipsCodeGen
    MipsAsmParser
    MipsDesc
    MipsInfo
    # ğŸ”¥ X86 ç»„ä»¶ï¼ˆæ–°å¢ï¼‰
    X86CodeGen
    X86AsmParser
    X86Desc
    X86Info
)

# æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶
add_llvm_executable(${PROJECT_NAME} 
    ./src/main.cpp  
    ./src/lexer.cpp  
    ./src/parser.cpp   
    ./src/codeGenerator.cpp
    ./src/symbolTable.cpp
    ./src/SymbolTypeBuilder.cpp
)

# ä¸ºç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶æ˜ç¡®æŒ‡å®šç¼–è¯‘é€‰é¡¹
target_compile_options(${PROJECT_NAME} PRIVATE -fexceptions)

# ç¡®ä¿ç§»é™¤ -fno-exceptions é€‰é¡¹
get_target_property(current_flags ${PROJECT_NAME} COMPILE_FLAGS)
if(current_flags)
    string(REPLACE "-fno-exceptions" "" new_flags "${current_flags}")
    set_target_properties(${PROJECT_NAME} PROPERTIES COMPILE_FLAGS "${new_flags}")
else()
    set_target_properties(${PROJECT_NAME} PROPERTIES COMPILE_FLAGS "-fexceptions")
endif()

# ğŸ”¥ å…³é”®ä¿®æ”¹ 4ï¼šæ­£ç¡®é“¾æ¥ LLVM ç»„ä»¶
llvm_config(${PROJECT_NAME} ${LLVM_LINK_COMPONENTS})
